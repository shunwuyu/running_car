(function(g){function o(v,A){var z=(v&65535)+(A&65535);var w=(v>>16)+(A>>16)+(z>>16);return(w<<16)|(z&65535)}function s(v,w){return(v<<w)|(v>>>(32-w))}function c(B,y,w,v,A,z){return o(s(o(o(y,B),o(v,z)),A),w)}function b(y,w,C,B,v,A,z){return c((w&C)|((~w)&B),y,w,v,A,z)}function i(y,w,C,B,v,A,z){return c((w&B)|(C&(~B)),y,w,v,A,z)}function n(y,w,C,B,v,A,z){return c(w^C^B,y,w,v,A,z)}function a(y,w,C,B,v,A,z){return c(C^(w|(~B)),y,w,v,A,z)}function d(G,B){G[B>>5]|=128<<(B%32);G[(((B+64)>>>9)<<4)+14]=B;var y;var A;var z;var w;var v;var F=1732584193;var E=-271733879;var D=-1732584194;var C=271733878;for(y=0;y<G.length;y+=16){A=F;z=E;w=D;v=C;F=b(F,E,D,C,G[y],7,-680876936);C=b(C,F,E,D,G[y+1],12,-389564586);D=b(D,C,F,E,G[y+2],17,606105819);E=b(E,D,C,F,G[y+3],22,-1044525330);F=b(F,E,D,C,G[y+4],7,-176418897);C=b(C,F,E,D,G[y+5],12,1200080426);D=b(D,C,F,E,G[y+6],17,-1473231341);E=b(E,D,C,F,G[y+7],22,-45705983);F=b(F,E,D,C,G[y+8],7,1770035416);C=b(C,F,E,D,G[y+9],12,-1958414417);D=b(D,C,F,E,G[y+10],17,-42063);E=b(E,D,C,F,G[y+11],22,-1990404162);F=b(F,E,D,C,G[y+12],7,1804603682);C=b(C,F,E,D,G[y+13],12,-40341101);D=b(D,C,F,E,G[y+14],17,-1502002290);E=b(E,D,C,F,G[y+15],22,1236535329);F=i(F,E,D,C,G[y+1],5,-165796510);C=i(C,F,E,D,G[y+6],9,-1069501632);D=i(D,C,F,E,G[y+11],14,643717713);E=i(E,D,C,F,G[y],20,-373897302);F=i(F,E,D,C,G[y+5],5,-701558691);C=i(C,F,E,D,G[y+10],9,38016083);D=i(D,C,F,E,G[y+15],14,-660478335);E=i(E,D,C,F,G[y+4],20,-405537848);F=i(F,E,D,C,G[y+9],5,568446438);C=i(C,F,E,D,G[y+14],9,-1019803690);D=i(D,C,F,E,G[y+3],14,-187363961);E=i(E,D,C,F,G[y+8],20,1163531501);F=i(F,E,D,C,G[y+13],5,-1444681467);C=i(C,F,E,D,G[y+2],9,-51403784);D=i(D,C,F,E,G[y+7],14,1735328473);E=i(E,D,C,F,G[y+12],20,-1926607734);F=n(F,E,D,C,G[y+5],4,-378558);C=n(C,F,E,D,G[y+8],11,-2022574463);D=n(D,C,F,E,G[y+11],16,1839030562);E=n(E,D,C,F,G[y+14],23,-35309556);F=n(F,E,D,C,G[y+1],4,-1530992060);C=n(C,F,E,D,G[y+4],11,1272893353);D=n(D,C,F,E,G[y+7],16,-155497632);E=n(E,D,C,F,G[y+10],23,-1094730640);F=n(F,E,D,C,G[y+13],4,681279174);C=n(C,F,E,D,G[y],11,-358537222);D=n(D,C,F,E,G[y+3],16,-722521979);E=n(E,D,C,F,G[y+6],23,76029189);F=n(F,E,D,C,G[y+9],4,-640364487);C=n(C,F,E,D,G[y+12],11,-421815835);D=n(D,C,F,E,G[y+15],16,530742520);E=n(E,D,C,F,G[y+2],23,-995338651);F=a(F,E,D,C,G[y],6,-198630844);C=a(C,F,E,D,G[y+7],10,1126891415);D=a(D,C,F,E,G[y+14],15,-1416354905);E=a(E,D,C,F,G[y+5],21,-57434055);F=a(F,E,D,C,G[y+12],6,1700485571);C=a(C,F,E,D,G[y+3],10,-1894986606);D=a(D,C,F,E,G[y+10],15,-1051523);E=a(E,D,C,F,G[y+1],21,-2054922799);F=a(F,E,D,C,G[y+8],6,1873313359);C=a(C,F,E,D,G[y+15],10,-30611744);D=a(D,C,F,E,G[y+6],15,-1560198380);E=a(E,D,C,F,G[y+13],21,1309151649);F=a(F,E,D,C,G[y+4],6,-145523070);C=a(C,F,E,D,G[y+11],10,-1120210379);D=a(D,C,F,E,G[y+2],15,718787259);E=a(E,D,C,F,G[y+9],21,-343485551);F=o(F,A);E=o(E,z);D=o(D,w);C=o(C,v)}return[F,E,D,C]}function p(w){var x;var v="";for(x=0;x<w.length*32;x+=8){v+=String.fromCharCode((w[x>>5]>>>(x%32))&255)}return v}function j(w){var x;var v=[];v[(w.length>>2)-1]=undefined;for(x=0;x<v.length;x+=1){v[x]=0}for(x=0;x<w.length*8;x+=8){v[x>>5]|=(w.charCodeAt(x/8)&255)<<(x%32)}return v}function k(v){return p(d(j(v),v.length*8))}function e(x,A){var w;var z=j(x);var v=[];var y=[];var B;v[15]=y[15]=undefined;if(z.length>16){z=d(z,x.length*8)}for(w=0;w<16;w+=1){v[w]=z[w]^909522486;y[w]=z[w]^1549556828}B=d(v.concat(j(A)),512+A.length*8);return p(d(y.concat(B),512+128))}function u(y){var A="0123456789abcdef";var w="";var v;var z;for(z=0;z<y.length;z+=1){v=y.charCodeAt(z);w+=A.charAt((v>>>4)&15)+A.charAt(v&15)}return w}function m(v){return unescape(encodeURIComponent(v))}function q(v){return k(m(v))}function l(v){return u(q(v))}function h(v,w){return e(m(v),m(w))}function r(v,w){return u(h(v,w))}function f(w,x,v){if(!x){if(!v){return l(w)}return q(w)}if(!v){return r(x,w)}return h(x,w)}if(typeof define==="function"&&define.amd){define(function(){return f})}else{if(typeof module==="object"&&module.exports){module.exports=f}else{g.md5=f}}}(Zepto));(function(b){function c(e){var f=this;if(!e){e={}}this.baseUrl=e&&e.baseUrl||"https://gsactivity.diditaxi.com.cn/gulfstream/activity/v2/h5activity/";this.apiName={initInfo:"initInfo",submitActivityData:"submitActivityData",getActivityDataByPhone:"getActivityDataByPhone",submitActivity:"submitActivity",uploadImg:"uploadImg",getCityInfoByPhone:"getCityInfoByPhone"};var d={uiWidth:750,activityID:f.tool.getActivityID(),sourceID:didi.query(e.sourceParam||"sourceid"),basePath:f.tool.getAbsolutePath(),shareUrl:f.tool.getShareUrl({params:e.shareParams||["sourceid"]})};this.conf=b.extend(d,e||{});f.initVoucherConf();this.ga=this.getGa();if(!this.conf.noInit&&this.conf.channel){this.initInfo()}if(!this.conf.noInitFont){setTimeout(function(){f.initFontSize(f.conf.uiWidth)},300)}this.initShare();b.each(f.apiName,function(g,i){if(g!="initInfo"){var h=f.requestApiByName.call(f,i);if(h){f[g]=h}}});this.log("init")}var a=c.prototype;a.tool={getActivityID:function(){var d="",e=/.*\/[modules|activity][^\/]*\/([^\/]+)\//g.exec(window.location.href);if(e&&e.length>1){d=e[1]}return d},getAbsolutePath:function(){var d=document.createElement("a");d.href="./";return d.href},getShareUrl:function(e){var h=e&&e.baseUrl||window.location.href,d=h.indexOf("?");var j,l=e&&e.params||[];if(d>-1){j=h.substr(0,d)}else{j=h}if(l&&l.length>0){for(var g=0;g<l.length;g++){var f=l[g],k=didi.query(f)||"";j+=(g==0?"?":"&")+f+"="+k}}return j},phoneCheck:function(d){if(/^1[3|4|5|8|7][0-9]\d{8}$/.test(d)){return true}else{return false}},loadImage:function(f,d){var e=new Image();e.src=f;if(e.complete){d&&d(e);return}e.onload=function(){d&&d(e)}},preLoadImgs:function(j,e){var d=j.length,h={},g={};g.length=0;for(var f=0;f<d;f++){this.loadImage(j[f],function(i){if(!h[i.src]){h[i.src]=true;var k=i.src.slice(i.src.lastIndexOf("/")+1,-4);g[k]=i;g.length+=1}if(g.length>=d){e&&e(g)}})}},isURL:function(f){var e="^((https|http)?://)(([0-9]{1,3}.){3}[0-9]{1,3}|([0-9a-z_!~*'()-]+.)*([0-9a-z][0-9a-z-]{0,61})?[0-9a-z].[a-z]{2,6})(:[0-9]{1,4})?((/?)|(/[0-9a-z_!~*'().;?:@&=+$,%#-]+)+/?)$";var d=new RegExp(e);return d.test(f)}};a.initShare=function(e){var d=this;if(!d.conf.noShare){var f=e&&e.shareImg||d.conf&&d.conf.wxdata&&d.conf.wxdata.shareImg||"images/wxshare.jpg";if(!d.tool.isURL(f)){f=d.conf.basePath+f}d.wxdata={title:"滴滴快车",desc:"滴滴快车",link:d.conf.shareUrl,icon:f,img_url:f,from:"native",sina_weibo:false,qzone:false,qq_appmsg:false};didi.setShare(b.extend(true,{success:function(){d.log("share-succ")},cancel:function(){d.log("share-cancel")}},d.wxdata,d.conf.wxdata,e||{}))}else{didi.setShare(false);didi.weixin(function(g){g.hideOptionMenu()})}};a.getShareData=function(){return b.extend(true,{},t.wxdata)};a.getGa=function(){var e=this,g;if(window.Ga&&typeof window.Ga==="function"){var d=(didi.is("weixin")?"weixin":(didi.is("app")?"app":(didi.is("mqq")?"mqq":"cli"))),f=(didi.is("ios")?"ios":(didi.is("android")?"android":"os"));g=new Ga({activeId:e.conf.activityID,os:f,cli:d})}return g};a.log=function(f){var e=this.ga,d=f+"-"+this.conf.activityID+(this.conf.sourceID?("-"+this.conf.sourceID):"");if(window._hmt||this._hmt){_hmt&&_hmt.push&&_hmt.push(["_trackEvent",d,"click"])}e&&e.trace&&e.trace({traceName:d,action:"trace"})};a.initFontSize=function(g,d,i){var f=g||750,e=d||20,k=i||30;var h=b(window).width(),j=h*e/f;if(j>=k){j=k}b("html").css({fontSize:j+"px"})};a.data2md5Str=function(e){var d="",i=[],h={},f={};function g(l){var j={},m,k=arguments.callee;b.each(l,function(n,o){if(typeof o==="object"){m=k(o)}else{m=""+o}j[""+n]=m});return j}h=g(e);b.each(h,function(j,k){i.push(j)});i.sort();b.each(i,function(j,k){var l=h[k];d+=(d===""?"":"-")+k+"="+(typeof l=="object"?JSON.stringify(l):l)});d=b.md5(d);return d};a.initInfo=function(h,i,l,d){var m=this,f="",k=didi.query("ticket"),e={},j={};if(m.conf.confSource){j={conf_source:"database"}}if(!k&&didi.is("app")){didi.bridge.getUserInfo(function(n){if(n.token){f=n.token}g()})}else{g()}function g(){var o=b.extend({g_channel:m.conf.channel,token:f,ticket:k},h||{},j),n=m.data2md5Str(o);b.ajax({type:"get",url:m.baseUrl+m.apiName.initInfo,data:b.extend({kvstr:n},o),dataType:"jsonp",async:true,timeout:5000,success:function(p){m.isInit=true;if(p&&p.errno==0){m.log("initInfo-succ");if(p.data){b.each(p.data,function(q,r){if(typeof r!=="object"){e[q]=r}});m.postData=e}i&&i(p)}else{m.log("initInfo-fail");l&&l(p);throw new Error("获取初始化数据失败")}},error:function(){m.isInit=true;m.log("initInfo-err");d&&d();throw new Error("获取初始化数据异常")}});b.ajax({type:"get",url:m.baseUrl+m.apiName.initInfo,data:b.extend({kvstr:n},o),dataType:"jsonp",async:true,timeout:5000,success:function(p){m.isInit=true;if(p&&p.errno==0){m.log("initInfo-succ");if(p.data){b.each(p.data,function(q,r){if(typeof r!=="object"){e[q]=r}});m.postData=e}i&&i(p)}else{m.log("initInfo-fail");l&&l(p);throw new Error("获取初始化数据失败")}},error:function(){m.isInit=true;m.log("initInfo-err");d&&d();throw new Error("获取初始化数据异常")}})}};a.initVoucherConf=function(){var d=this;d.voucherConf={next:1,psec:0.6,maxsec:10,st:null}};a.getVoucherByPhone=function(h,e,g,d){var f=this;f.initVoucherConf();f.submitActivity(b.extend({channel:"fetchCoupon",func:"fetchCoupon"},h),function(i){f.poolVoucherByPhone(h,e,g,d);f.log("getVoucherByPhone-succ")},function(i){f.log("getVoucherByPhone-fail");g&&g(i)},function(){f.log("getVoucherByPhone-err");d&&d();throw new Error("领券异常")})};a.poolVoucherByPhone=function(h,e,g,d){var f=this;f.submitActivity(b.extend({channel:"fetchCoupon",func:"getCouponInfo"},h),function(i){f.log("poolVoucherByPhone-succ");e&&e(i)},function(i){if(f.voucherConf.next>f.voucherConf.maxsec){f.log("poolVoucherByPhone-fail-maxsec");f.voucherConf.st&&clearTimeout(f.voucherConf.st);g&&g(i);return}else{f.voucherConf.st=setTimeout(function(){f.voucherConf.next+=f.voucherConf.psec;f.poolVoucherByPhone(h,e,g,d)},f.voucherConf.next*1000);return}},function(){f.log("poolVoucherByPhone-err");d&&d();throw new Error("获取券信息异常")})};a.getVoucher=function(h,e,g,d){var f=this;f.submitActivity(b.extend({channel:"fetchCoupon",func:"fetchCoupon"},h),function(i){},function(i){},function(){})};a.requestApiByName=function(d){var e=this;if(typeof e[d]=="function"){return}return function(j,g,i,f){if(!e.isInit){if(e.conf.noInit){e.initInfo({},function(){h()})}else{e.st=setInterval(function(){if(e.isInit){clearInterval(e.st);h()}},300);setTimeout(function(){clearInterval(e.st)},3000)}}else{h()}function h(){var k={};if(e.conf.confSource){k={conf_source:"database"}}var m=b.extend(true,{},e.postData,j,k),l=d==="uploadImg"?"post":"get",n=d=="uploadImg"?"json":"jsonp";b.ajax({type:l,url:e.baseUrl+e.apiName[d],data:l=="post"?m:b.extend({kvstr:e.data2md5Str(m)},m),dataType:n,async:true,timeout:5000,success:function(o){if(o&&o.errno==0){e.log(e.apiName[d]+"-succ");g&&g(o)}else{e.log(e.apiName[d]+"-fail");i&&i(o)}},error:function(){e.log(e.apiName[d]+"-err");f&&f();throw new Error("获取初始化数据异常")}})}}};window.DidiActivity=c})(Zepto);
